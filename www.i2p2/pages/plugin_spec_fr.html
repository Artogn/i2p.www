{% extends "_layout_fr.html" %}
{% block title %}Spécification des greffons I2P{% endblock %}
{% block content %}
Traduction d'avril 2011. <a href="plugin_spec.html">Version anglaise actuelle</a>
<h2>
Spécification Version 0.16
2010-07-26
</h2>
<p> 
Mise à jour de juillet 2010 pour le routeur version 0.8.
<h3>Aperçu</h3>
<p> 
Ce document spécifie un format de fichier .xpi2p (comme le .xpi de Firefox), mais avec un simple fichier de description 
plugin.config au lieu du fichier XML install.rdf. Ce fichier est utilisé pour l'installation initiale et pour les mises 
à jour.
<p>
De plus, ce document présente un aperçu résumé de l'installation des greffons par le routeur, et les stratégies et les 
grandes lignes de travail pour les développeurs.
<p>
Le format de base du fichier .xpi2p est le même que celui du fichier i2pupdate.sud (utilisé pour les mises à jour du 
routeur), mais le programme d'installation laisse faire l'utilisateur même si la clé de signature n'est pas encore 
connue.
<p>
La structure standard des répertoires permet l'installation des types de greffons suivants :
<ul>
<li>
	 applications web de console (webapps)
<li>
	 nouvel eepsite avec cgi-bin, webapps
<li>
	 thèmes de console
<li>
	 traductions de console
<li>
	 programmes Java
<li>
	 programmes Java dans une JVM séparée
<li>
	 Tout script shell ou programme
</ul>

<p>
Un greffon installe tous ses fichiers dans ~/.i2p/plugins/nom/ (%APPDIR%\I2P\plugins\nom\ sur Windows). Le programme 
d'installation empêche l'installation ailleurs, bien que le greffon puisse accéder pour son fonctionnement à des 
bibliothèques situées en dehors de cette arborescence.

<p>
Ceci doit seulement être considéré comme un moyen pour faciliter l'installation, la désinstallation, et les mises à 
jour, ainsi que pour minimiser les conflits entre greffons.

<p>
Cependant, il n'y a pas de modèle de sécurité imposé lorsque le greffon est en cours d'exécution. Les greffons tournent 
dans la même JVM et avec les même privilèges que le routeur : ils ont l'accès total au système de fichiers, au routeur, 
à l'exécution de programmes etc&hellip;
<h3>Détails</h3>
<p>
foo.xpi2p est un fichier sud contenant les données suivantes :
<pre>
	En-tête standard .sud au début du fichier zip, contenant :
	        La <a href="how_cryptography.html#DSA">signature DSA</a> à 40 octets
		La version du greffon sur 16 octets en UTF-8, complétée par des zéros en fin si nécessaire

	Le fichier Zip contenant :

		(REQUIS) un fichier plugin.config :
		(fichier standard de configuration I2P, en UTF-8, contenant des lignes clé=valeur, les commentaires 
		commençant par #)
		Contenant les propriétés suivantes :

		(* = requis)
			Les trois premières doivent être identiques à celles du greffon installé s'il s'agit d'une mise 
			à jour.

			*name (le greffon sera installé dans ce dossier)
				Pour les greffons spécifiques à un SE donné, vous pouvez séparer les noms pour des 
				paquets différents, par exemple truc-windows et truc-linux.
			*key (<a href="how_cryptography.html#DSA">clé publique DSA</a> sous forme Base64
				de 172 caractères finissant '=')
			*signer (votrenom@mail.i2p recommendé)

			*version (dans un format compatible avec VersionComparator, p.e. 1.2.3-4)
				16 octets maximum (doit correspondre à la version du sud)
				Les séparateurs acceptés sont '.', '-', et '_'
				Pour une mise à jour de greffon, doit être supérieure à celle actuellement installée.


			configclients.jsp affichera les éléments suivants s'ils sont présents :

			date (temps Java - entier long)
			author (votrenom@mail.i2p recommendé)
			websiteURL (http://truc.i2p/)
			updateURL (http://truc.i2p/truc.xpi2p)
				Le vérificateur de mises à jour contrôle les octets 41 à 56 à cette URL pour déterminer 
				si une nouvelle version est disponible
				( Le vérificateur va-t-il télécharger avec ?currentVersion=1.2.3?...
				  Non. Si le développeur que l'URL contienne la version actuelle, il doit le préciser 
				  dans le fichier de configuration, et penser à le modifier à chaque nouvelle version)
			description
			description_xx (pour la langue xx)
			license
			disableStop=true
				Par défault, false.
				À true, le bouton "Arrêt" n'est pas affiché. À utiliser s'il n'y pas de client ni de 
				webapp avec des arguments d'arrêt.

			Les éléments suivants servent à l'affichage d'un lien dans le panneau de contrôle de la console:

			consoleLinkName (nom affiché dans le panneau de contrôle)
			consoleLinkName_xx (pour la langue xx)
			consoleLinkURL (/appname/index.jsp)
			consoleLinkTooltip (supporté depuis la version 0.7.12-6)
			consoleLinkTooltip_xx (idem, pour la langue xx)
			

			Les éléments suivants concernent l'installeur du greffon :

			type (app/theme/locale/webapp/...) (non implémenté, probablement inutile)
			min-i2p-version
			max-i2p-version
			min-java-version
			min-jetty-version
			max-jetty-version
			required-platform-OS (non implémenté - sera peut-être seulement affiché, pas vérifié)
			other-requirements (non implémenté p.e. python x.y - non vérifié par l'installeur, uniquement 
			 affiché)
			dont-start-at-install=true
				false par défaut.
			router-restart-required=true
				false par défaut.
				dont-start-at-install doit être positionné à true pour être actif.
				Ceci ne redémarre pas le routeur, indique seulement la nécessité de redémarrer.
			update-only=true
				false par défaut.
				À true, un échec se produira si le greffon n'est pas déjà installé.
			install-only=true
				false par défaut.
				À true, si le greffon est déjà installé, l'installation échouera.
			min-installed-version (version minimale requise pour la mise à jour)
			max-installed-version (version maximale requise pour la mise à jour)
			depends=plugin1,plugin2,plugin3 (non implémenté - trop difficile? proposé par sponge)
			depends-version=0.3.4,,5.6.7 (non implémenté)

			Les éléments suivants sont pour les greffons de traduction :
			langs=xx,yy,Klingon,... (non implémenté) (yy est le drapeau du pays)

		Tous les dossiers et fichiers suivants sont optionnels , mais il faut mettre quelque-chose, ou il ne se 
		passera rien :
			
		console/
			locale/
				Seulement des jars contenant de nouvelles ressources (traductions) pour les 
				applications de l'install de base I2P.
				Les paquets de ce greffon vont dans console/webapp/truc.war ou lib/truc.jar

			themes/
				Nouveaux thèmes pour la console
				Copier chaque thème dans un sous dossier.

			webapps/
				(voir plus bas les remarques importantes sur les applications web)
				.wars
				Ils seront lancés à l'installation sauf si désactivés dans webapps.config
				Le nom du .war ne doit pas nécessairement être le même que celui du greffon.
				Ne pas utiliser plusieurs fois le même nom de .war dans l'installation de base.

			webapps.config 
				Même format que le webapps.config du routeur
				Sert aussi à indiquer des .jars supplémentaires dans $PLUGIN/lib/ ou $I2P/lib pour le 
				classpath de la webapp, avec 
				webapps.warname.classpath=$PLUGIN/lib/foo.jar,$I2P/lib/bar.jar
				NOTE : actuellement, la ligne classpath n'est chargée que si le nom du war est le même
				que celui du greffon.
				NOTE : avant sa version 0.7.12-9, le routeur cherchait plugin.warname.startOnLoad au 
				lieu de webapps.warname.startOnLoad. Pour la compatibilité avec les versions
				antérieures, si un greffon doit désactiver un war, il doit comporter les deux lignes.

		eepsite/
			(Voir plus bas les remarques importantes sur les eepsites)
			cgi-bin/
			docroot/
			logs/
			webapps/
			jetty.xml
				L'installeur devra y substituer la variable pour définir le chemin
				L'emplacement et le nom de ce fichier ne sont pas vraiment importants, tant qu'ils sont 
				définis dans clients.config - il peut être plus pratique d'être un niveau au dessus
				dans l'arborescence (comme le fait le greffon zzzot)

		lib/
			Pour tous les jars. Les indiquer dans une ligne classpath de console/webapps.config et/ou
			clients.config

		clients.config (même format que le clients.config du routeur)
			Lancés quand un greffon est démarré
			Commence à client #0, en numérotation consécutive
			New property clientApp.0.stopargs=truc machin stop bidule
				Si présente, la classe sera appelée avec ces arguments pour arrêter le client
				Toutes les tâches d'arrêt sont appelées avec un délais nul
				Note: Le routeur ne peut pas dire si les clients tournent ou pas.
                                Chacun doit pouvoir gérer une demande d'arrêt d'une application qui ne tourne pas sans 
				faire d'histoires.
				Idem pour le lancement d'un client déjà démarré.
			New property clientApp.0.uninstallargs=truc machin uninstall bidule
				Si présente, la classe sera appelée avec ces arguments juste avant la suppression de 
				$PLUGIN
				Toutes les tâches de désinstallation sont appelées avec un délais nul
			New property clientApp.0.classpath=$I2P/lib/truc.muche,$PLUGIN/lib/bidule.jar
				L'exécutable du greffon devra faire une substitution de variable dans les lignes des 
				les arguments et les stopargs de la façon suivante :
				$I2P => dossier d'installation de base d'I2P;
				$CONFIG => dossier de configuration d'i2p (habituellement ~/.i2p)
				$PLUGIN => le dossier d'installation du greffon (habituellement ~/.i2p/plugins/appname)
			(Voir les remarques importantes sur les scripts d'exécution shell ou les programmes externes)
</pre>


<h3>Tâches d'installation du greffon</h3>
Séquence d'installation.
<ul>

    <li>Téléchargement du fichier .xpi2p.</li>
    <li>Vérification de la signature du .sud par rapport au clés connues. En l'absence de correspondance, le .sud est 
	extrait, la clé est chargée à partir des propriétés, vérifiée et enregistrée.</li>
    <li>Vérification de l'intégrité du fichier zip.</li>
    <li>Extraction du fichier plugin.config.</li>
    <li>Vérification de la version d'I2P, pour assurer que le greffon peut fonctionner.</li>
    <li>Vérification qu'il ne s'agit pas d'un doublon d'une des application $I2P.</li>
    <li>Arrêt de l'éventuel greffon existant.</li>
    <li>Contrôle de l'inexistence du dossier d'installation si update=false, ou demande d'écrasement.</li>
    <li>Vérification de l'existence du dossier d'installation update=true, ou demande de création.</li>
    <li>Décompression du greffon dans appDir/plugins/name/</li>
    <li>Ajout d'une référence au greffon dans plugins.config</li>
</ul>

<h3>
Plugin starter tasks
</h3>
This lists what happens when plugins are started.
First, plugins.config is checked to see which plugins need to be started.
For each plugin:
<ul>
    <li>Check clients.config, and load and start each item (add the configured jars to the classpath).</li>
    <li>Check console/webapp and console/webapp.config. Load and start required items (add the configured jars to the classpath).</li>
    <li>Add console/locale/foo.jar to the translation classpath if present.</li>
    <li>Add console/theme to the theme search path if present.</li>
    <li>Add the summary bar link.</li>
</ul>

<h3>
Console webapp notes
</h3>
<p>
Console webapps with background tasks should implement a ServletContextListener
(see seedless or i2pbote for examples), or override destroy() in the servlet,
so that they can be stopped.
As of router version 0.7.12-3, console webapps will always be stopped before they
are restarted, so you do not need to worry about multiple instances,
as long as you do this.
Also as of router version 0.7.12-3, console webapps will be stopped at router shutdown.
<p>
Don't bundle library jars in the webapp; put them in lib/ and put a classpath in webapps.config.
Then you can make separate install and update plugins, where the update plugin does not
contain the library jars.
<p>
Don't include .java or .jsp files; otherwise jetty will recompile them at installation.
<p>
For now, a webapp needing to add classpath files in $PLUGIN must be the same name as the plugin.
For example, a webapp in plugin foo must be named foo.war.


<h3>
Eepsite notes
</h3>
<p>
It isn't clear how to have a plugin install to an existing eepsite.
The router has no hook to the eepsite, and it may or may not be running,
and there may be more than one.
Better is to start your own Jetty instance and I2PTunnel instance,
for a brand new eepsite.
<p>
 It can instantiate a new I2PTunnel (kinda like the i2ptunnel CLI does),
  but it won't appear in the i2ptunnel gui of course, that's a different instance.
But that's ok. Then you can start and stop i2ptunnel and jetty together.
<p>
So don't count on the router to automatically merge this with some existing eepsite. It probably won't happen.
Start a new I2PTunnel and Jetty from clients.config.
The best examples of this are the zzzot and pebble plugins,
available at <a href="http://stats.i2p/i2p/plugins/">zzz's plugins page</a>.
<p>
How to get path substitution into jetty.xml?
See zzzot and pebble plugins for examples.


<h3>
Client start/stop notes
</h3>
<p>
The router has no way to monitor the state of clients started via clients.config.
The plugin author should handle multiple start or stop calls gracefully, if at all possible,
by keeping a static state table, or using PID files, etc.
Avoid logging or exceptions on multiple starts or stops.
This also goes for a stop call without a previous start.
As of router version 0.7.12-3, plugins will be stopped at router shutdown,
which means that all clients with stopargs in clients.config will be called,
whether or not they were previously started.


<h3>
Shell script and external program notes
</h3>
<p>
To run shell scripts or other external programs, see <a href="http://zzz.i2p/topics/141">zzz.i2p</a>
<p>
To work on both Windows and Linux, write a small Java class that checks the OS type, then
runs ShellCommand on either the .bat or a .sh file you provide.
<p>
External programs won't be stopped when the router stops, and a second copy will
fire up when the router starts. To work around this, you could
write a wrapper class or shell script that does the usual storage of the PID
in a PID file, and check for it on start.




<h3>
Other plugin guidelines
</h3>
<ul>
<li>
See i2p.scripts branch or any of the sample plugins on zzz's page for a xpi2p file generator to make it easy.
<li>
Pack200 of jars and wars is strongly recommended for plugins, it generally shrinks plugins by 60-65%.
See any of the sample plugins on zzz's page for an example.
Pack200 unpacking is supported on routers 0.7.11-5 or higher, which is essentially all routers that
support plugins at all.

<li>
 Plugins should not attempt to write anywhere in $I2P as it may be readonly, and that isn't good policy anyway.
<li>
 Plugins may write to $CONFIG but keeping files in $PLUGIN only is recommended.
All files in $PLUGIN will be deleted at uninstall.
Files elsewhere will not be deleted at uninstall unless the plugin does it explicitly
with a client in clients.config run with uninstallargs.
If the user may want to save data after uninstallation, the uninstallargs hook
could ask.

<li>
 $CWD may be anywhere; do not assume it is in a particular place, do not attempt to read or write files relative to $CWD.
<li>
 Java programs should find out where they are with the directory getters in I2PAppContext.
<li>
 Plugin directory is I2PAppContext.getGlobalContext().getAppDir().getAbsolutePath() + "/plugins/" + appname,
  or put a $PLUGIN argument in the args line in clients.config.
There is no reliable way to find the i2p install or config or plugin directory without using the
context API in i2p.jar.
<li>
 See <a href="http://zzz.i2p/topics/16">Howto</a> for info on generating signing keys and generating/verifying keys and sud files
<li>
 All config files must be UTF-8.
<li>
 To run in a separate JVM, use ShellCommand with java -cp foo:bar:baz my.main.class arg1 arg2 arg3.
Of course, it will be a lot harder to stop the plugin then...
But with some trickery with PID files it should be possible.
<li>
 As an alternative to stopargs in clients.config,
 a Java client may register a shutdown hook with I2PAppContext.addShutdownTask().
 But this wouldn't shut down a plugin when upgrading, so stopargs is recommended.
  Also, set all created threads to daemon mode.
<li>
 Do not include classes duplicating those in the standard installation. Extend the classes if necessary.
<li>
 Beware of the different classpath definitions in wrapper.config between old and new installations -
 see classpath section below.
<li>
 Clients will reject duplicate keys with different keynames, and duplicate keynames with different keys,
  and different keys or keynames in upgrade packages. Safeguard your keys. Only generate them once.
<li>
 Do not modify the plugin.config file at runtime as it will be overwritten on upgrade.
  Use a different config file in the directory for storing runtime configuration.
<li>
 In general, plugins should not require access to $I2P/lib/router.jar. Do not access router classes,
unless you are doing something special.
The router may in the future implement a restricted classpath for plugins that prevents
access to router classes.
<li>
Since each version must be higher than the one before, you could enhance your build
script to add a build number to the end of the version.
This helps for testing. Most of zzz's plugins have that feature, check build.xml for an example.
<li>
Plugins must never call System.exit().
<li>
Please respect licenses by meeting license requirements for any software you bundle.

</ul>

<h3>
Classpaths
</h3>

The following jars in $I2P/lib can be assumed to be in the standard classpath for all I2P installations,
no matter how old or how new the original installation:
<p>
 i2p.jar, router.jar, jbigi.jar, sam.jar, mstreaming.jar, streaming.jar, i2ptunnel.jar,
 org.mortbay.jetty.jar, javax.servlet.jar, jasper-compiler.jar, jasper-runtime.jar,
 commons-logging.jar, commons-el.jar, wrapper.jar, systray.jar, systray4j.jar
<p>

 Anything not listed above may not be present in everybody's classpath, even if you
 have it in the classpath in YOUR version of i2p.
 If you need any jar not listed above, add $I2P/lib/foo.jar to the classpath specified
 in clients.config or webapps.config in your plugin.
<p>
Previously, a classpath entry specified in clients.config was added to the classpath for
the entire JVM.
However, as of 0.7.13-3, this was fixed using class loaders, and now, as originally intended,
the specified classpath in clients.config is only for the particular thread.
See the section on JVM crashes below, and
<a href="http://zzz.i2p/topics/633">this thread on zzz.i2p</a> for background.
Therefore, specify the full required classpath for each client.


<h3>
Java Version Notes
</h3>
While most I2P users are running a 1.6 (6.0) JVM, we support 1.5 (5.0) and higher JVMs.
Unless you require 1.6 features, you should create your plugin so it works on 1.5.
<p>
If your plugin <b>does not require 1.6</b>:
<ul>
<li>
Ensure that all java and jsp files are compiled with source="1.5" target="1.5".
<li>
Ensure that all bundled library jars are also for 1.5 or lower.
<li>
If you are using pack200, any 1.6 classes in a jar will
cause pack200 to create a 1.6 pack format, and
plugin installation will fail on a 1.5 system
with the misleading message "plugin is corrupt".
</ul>

<p>
If your plugin <b>requires 1.6</b>:
<ul>
<li>
Note that on your download page.
<li>
Add min-java-version=1.6 to your plugin.config
<li>
If you are using pack200, plugin installation will fail on a 1.5 system
with the misleading message "plugin is corrupt".
</ul>


<h3>
JVM Crashes When Updating
</h3>
Note - this should all be fixed now.
<p>
The JVM has a tendency to crash when updating jars in a plugin if that plugin was running
since i2p was started (even if the plugin was later stopped).
This may have been fixed with the class loader implementation in 0.7.13-3, but it may not.
For further testing.
<p>
The safest is to design your plugin with the jar inside the war (for a webapp), or to require a restart
after update, or don't update the jars in your plugin.
<p>
Due to the way class loaders work inside a webapp, it _may_ be safe to have external jars if
you specify the classpath in webapps.config.
More testing is required to verify this.
Don't specify the classpath with a 'fake' client in clients.config if it's only
needed for a webapp - use webapps.config instead.
<p>
The least safe, and apparently the source of most crashes, is clients with plugin jars specified
in the classpath in clients.config.

<p>
None of this should be a problem on initial install - you should not ever have to require a restart
for an initial install of a plugin.

{% endblock %}
